{% extends "base.html" %}
{% block content %}
<div class="dashboard">
  <h2>Welcome, {{ current_user.name or current_user.email }} ðŸ‘‹</h2>

  <!-- Summary Cards -->
  <div class="summary-grid">
    <div class="summary-card income">
      <h3>Total Income</h3>
      <p>GHS {{ "%.2f"|format(total_income) }}</p>
    </div>
    <div class="summary-card expense">
      <h3>Total Expense</h3>
      <p>GHS {{ "%.2f"|format(total_expense) }}</p>
    </div>
    <div class="summary-card balance">
      <h3>Balance</h3>
      <p>GHS {{ "%.2f"|format(balance) }}</p>
    </div>
  </div>

  <!-- Charts Section -->
  <section class="charts-section">
    <div class="chart-box">
      <h4>Spending by Category</h4>
      <canvas id="categoryChart"></canvas>
    </div>
    <div class="chart-box">
      <h4>Monthly Overview</h4>
      <canvas id="monthlyChart"></canvas>
    </div>
  </section>

  <!-- Recent Transactions -->
  <h3>Recent Transactions</h3>
  <div class="table-container">
    <table>
      <thead>
        <tr>
          <th>Date</th>
          <th>Type</th>
          <th>Category</th>
          <th>Amount (GHS)</th>
          <th>Note</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody>
        {% for t in transactions %}
        <tr>
          <td>{{ t.date }}</td>
          <td>{{ t.t_type }}</td>
          <td>{{ t.category }}</td>
          <td>{{ "%.2f"|format(t.amount) }}</td>
          <td>{{ t.note or "" }}</td>
          <td>
            <form action="{{ url_for('delete_transaction', txn_id=t.id) }}" method="post" style="display:inline;">
              <button type="submit" class="delete-btn" onclick="return confirm('Delete this transaction?')">Delete</button>
            </form>
          </td>
        </tr>
        {% else %}
        <tr><td colspan="6">No transactions yet. Add one!</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<!-- Chart.js Scripts -->
 <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  const categoryTotals = JSON.parse('{{ category_totals | tojson | safe }}');
  const monthlyTotals = JSON.parse('{{ monthly_totals | tojson | safe }}');

  // --- Category Pie Chart ---
  new Chart(document.getElementById('categoryChart'), {
    type: 'pie',
    data: {
      labels: Object.keys(categoryTotals),
      datasets: [{
        label: 'Expenses by Category',
        data: Object.values(categoryTotals),
        backgroundColor: [
          '#4caf50', '#2196f3', '#ff9800', '#f44336', '#9c27b0', '#ffc107'
        ]
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { position: 'bottom' },
        title: { display: false }
      }
    }
  });

  // --- Monthly Bar Chart ---
  const months = Object.keys(monthlyTotals).sort();
  const incomeData = months.map(m => monthlyTotals[m].income);
  const expenseData = months.map(m => monthlyTotals[m].expense);

  new Chart(document.getElementById('monthlyChart'), {
    type: 'bar',
    data: {
      labels: months,
      datasets: [
        { label: 'Income', data: incomeData, backgroundColor: '#4caf50' },
        { label: 'Expense', data: expenseData, backgroundColor: '#f44336' }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { position: 'bottom' }
      },
      scales: { y: { beginAtZero: true } }
    }
  });
</script>
{% endblock %}
